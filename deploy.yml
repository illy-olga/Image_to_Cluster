- name: Deploy Nginx on K3d
  hosts: localhost
  gather_facts: false
  tasks:
    - name: Build Docker image with Packer
      shell: |
        packer init nginx.pkr.hcl
        packer build nginx.pkr.hcl

    - name: Import image into K3d cluster
      shell: k3d image import nginx-custom:latest -c lab

    - name: Deploy Nginx Deployment
      shell: |
        kubectl apply -f - <<EOF
        apiVersion: apps/v1
        kind: Deployment
        metadata:
          name: nginx
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: nginx
          template:
            metadata:
              labels:
                app: nginx
            spec:
              containers:
                - name: nginx
                  image: nginx-custom:latest
                  imagePullPolicy: IfNotPresent
                  ports:
                    - containerPort: 80
        EOF

    - name: Deploy Nginx Service
      shell: |
        kubectl apply -f - <<EOF
        apiVersion: v1
        kind: Service
        metadata:
          name: nginx
        spec:
          type: NodePort
          selector:
            app: nginx
          ports:
            - port: 80
              targetPort: 80
              nodePort: 30081
        EOF

    - name: Force rollout to refresh image
      shell: kubectl rollout restart deployment nginx